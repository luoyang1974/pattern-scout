##  根据代码分析，动态基线预计算系统计算和输出的内容如下：

  计算内容

  1. 八种技术指标类型

  动态基线系统计算以下技术指标的历史分布：

  class IndicatorType(Enum):
      SLOPE_SCORE = "slope_score"                    # 斜率评分
      VOLUME_BURST = "volume_burst"                  # 成交量爆发比
      RETRACE_DEPTH = "retrace_depth"                # 回撤深度比
      VOLUME_CONTRACTION = "volume_contraction"      # 成交量收缩比
      VOLATILITY_DROP = "volatility_drop"            # 波动率下降比
      CHANNEL_WIDTH = "channel_width"                # 通道宽度
      PARALLELISM = "parallelism"                    # 平行度
      CONVERGENCE = "convergence"                    # 收敛度

  2. 两种市场状态分类

  对每种指标计算两种市场波动状态下的基线：

  class MarketRegime(Enum):
      HIGH_VOLATILITY = "high_volatility"  # 高波动状态
      LOW_VOLATILITY = "low_volatility"    # 低波动状态

  3. 三层鲁棒统计处理

  对500K线滚动窗口数据进行三层防护处理：

  - 第一层 - MAD过滤: 使用中位数绝对偏差去除异常值
  - 第二层 - 缩尾处理: Winsorize处理，默认限制在2%~98%范围
  - 第三层 - 动态阈值调整: 数据不足时自动放宽限制

  输出内容

  1. 鲁棒化百分位数

  计算四个关键百分位数（默认）：
  percentiles = [75, 85, 90, 95]

  2. DynamicBaseline对象结构

  每个基线输出包含：

  @dataclass
  class DynamicBaseline:
      regime: MarketRegime           # 市场状态（高/低波动）
      indicator_type: IndicatorType  # 指标类型
      sample_size: int              # 有效样本数量
      percentiles: Dict[int, float] # 关键百分位数 {75: 0.3, 85: 0.4, 90: 0.5, 95: 0.6}
      last_updated: datetime        # 更新时间戳
      is_stable: bool              # 稳定性标志（稳定性得分>0.7）
      raw_data_window: List[float] # 最近100个原始数据点

  3. 稳定性评分

  基于数据变异系数和一致性计算：
  - 稳定性得分: 0-1之间，>0.7视为稳定
  - 变异系数: 标准差/均值
  - 置信区间: 用于评估数据可靠性

  4. 动态阈值查询

  提供阈值查询API：
  def get_threshold(regime, indicator_type, percentile, fallback_value) -> float

  5. 基线存储结构

  双层字典结构存储：
  baselines: Dict[MarketRegime, Dict[IndicatorType, DynamicBaseline]] = {
      MarketRegime.HIGH_VOLATILITY: {
          IndicatorType.SLOPE_SCORE: DynamicBaseline(...),
          IndicatorType.VOLUME_BURST: DynamicBaseline(...),
          # ... 其他指标
      },
      MarketRegime.LOW_VOLATILITY: {
          # ... 同样结构
      }
  }

  6. 实时更新机制

  - 滚动更新: 每个新数据点触发基线重计算
  - 窗口管理: 维持500K线窗口大小
  - 状态切换: 动态检测市场状态变化

  动态基线系统通过这种方式为旗形检测提供自适应的阈值参考，根据历史统计数据和当前市场状态动态调整识别参数。

##   动态基线计算方法分析

  核心架构

  动态基线系统采用500K线滚动统计，通过三层鲁棒统计保护机制建立智能市场状态检测：

  1. 基线管理器 (BaselineManager)

  核心参数：
  - history_window: int = 500 - 历史数据窗口大小（500K线滚动窗口）
  - 维护两种市场状态下的基线：HIGH_VOLATILITY 和 LOW_VOLATILITY
  - 针对8种动态指标类型建立独立基线

  2. 三层鲁棒统计保护机制

  通过 RobustStatistics 类实现：

  第一层 - MAD过滤：
 

```
  mad_threshold: float = 2.5  # MAD异常值检测阈值
  # 使用中位数绝对偏差过滤异常值
  # MAD = median(|xi - median(x)|) * 1.4826

```

  第二层 - 缩尾处理：

```
  winsorize_limits: Tuple[float, float] = (0.02, 0.98)  # 2%和98%百分位缩尾
  # 将极值替换为边界值

```

  第三层 - 动态阈值调整：

```
  # 当处理后数据量不足50个点时，使用更宽松的(0.05, 0.95)限制
  # 自适应调整机制，防止过度过滤

```

  3. 使用动态基线的关键参数

  动态指标类型 (IndicatorType)：

  1. SLOPE_SCORE (斜率分) - 旗杆强度评估

    - P90阈值: 0.5, P85: 0.3, P75: 0.2
  2. VOLUME_BURST (量能爆发比) - 成交量突增检测

    - P90阈值: 2.0, P85: 1.5, P75: 1.2
  3. RETRACE_DEPTH (回撤深度比) - 形态回撤分析

    - P75阈值: 0.4, P60: 0.3, P50: 0.25
  4. VOLUME_CONTRACTION (量能收缩比) - 旗面量缩特征

    - P60阈值: 0.7, P50: 0.8, P40: 0.9
  5. VOLATILITY_DROP (波动下降比) - 波动率变化
  6. CHANNEL_WIDTH (通道宽度) - 形态几何特征
  7. PARALLELISM (平行度) - 矩形旗特征
  8. CONVERGENCE (收敛度) - 三角旗特征

  4. 市场状态检测机制

  RegimeDetector 智能状态机：

  核心参数：
  atr_period: int = 100          # ATR计算周期
  high_vol_threshold: float = 0.65   # 高波动阈值(P65)
  low_vol_threshold: float = 0.35    # 低波动阈值(P35)
  history_window: int = 500          # ATR历史窗口
  stability_buffer: int = 5          # 防震荡确认次数

  智能转换逻辑：
  - 需要连续5次确认才能切换市场状态
  - 防止1小时内超过3次频繁转换
  - ATR百分位数验证转换合理性

  5. 动态基线更新流程

  BaselineManager.update_baseline() 核心流程：

  1. 数据积累: 维护500K线滚动缓冲区
  2. 最少样本要求: 需要至少50个有效样本
  3. 稳健计算: 应用三层统计保护计算百分位数
  4. 稳定性评估: 计算baseline稳定性得分 (>0.7认为稳定)
  5. 阈值生成: 生成P75, P85, P90, P95等关键阈值

  6. 阈值获取策略

  BaselineManager.get_threshold() 智能回退机制：

  1. 首选: 使用当前市场状态的基线数据
  2. 备选: 如无数据，使用另一状态的基线
  3. 保底: 使用硬编码的保守默认值
  4. 最终: 返回NaN表示无可用阈值

  总结

  动态基线系统通过500K线滚动窗口建立了8种核心技术指标在两种市场波动状态下的稳健统计基线，并通过三层统计保护机制确保阈值的可靠性。这套系统为旗形识别算法提供了自适应的动态阈值，能够根据市场状态智能调整检测参数，显著
  提高了形态识别的准确性和稳定性。
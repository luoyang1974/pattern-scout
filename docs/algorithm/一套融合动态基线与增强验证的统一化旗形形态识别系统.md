## **一套融合动态基线与增强验证的统一化旗形形态识别系统**

**核心设计哲学**

本系统将旗形识别视为一个连续的、环环相扣的验证过程。它摒弃了所有静态阈值，通过**动态基线**实现对市场环境的完全自适应。整个流程分为三个核心阶段：

1.  **动态旗杆识别**：以“短暂而暴力”为纲，但使用动态标准，在市场中捕捉真正具备启动能量的趋势脉冲。
2.  **智能旗面验证**：以前沿的验证逻辑，确保随后的盘整是高质量的“能量压缩”，而非趋势衰竭。
3.  **确认与执行**：只有在前两步都通过最高标准验证后，才进入最终的突破交易逻辑。

**核心流程：阶段式验证**

`阶段 0：动态基线预计算` -> `阶段 1：动态旗杆识别 (触发器)` -> `阶段 2：智能旗面验证 (过滤器)` -> `阶段 3：突破确认与执行 (行动点)`

---

### **阶段 0：动态基线预计算与滚动更新**

此为系统的“大脑”，为后续所有判断提供自适应的“标尺”。

*   **数据源**：使用过去 `N=500` 根K线作为滚动统计样本。
*   **计算指标**：系统会持续计算并更新以下指标的**百分位数分布 (Percentile)**，特别是 `P75`, `P85`, `P90`, `P95` 等关键位置。
    *   **旗杆指标**：`SlopeScore` (斜率分)、`VolumeBurst` (量能爆发比)。
    *   **旗面指标**：`RetraceDepth` (回撤深度比)、`VolumeContraction` (量能收缩比)、`VolatilityDrop` (波动下降比)、`ChannelWidth` (通道宽度)、`Parallelism` (平行度)、`Convergence` (收敛度)。
*   **冷启动机制**：在新市场或数据不足时，系统将启用一套内置的、相对保守的**备用静态阈值**，直到积累足够的数据（如 `N ≥ 200`）后，再无缝切换到动态基线模式。

---

### **阶段 1：动态旗杆识别 (The Trigger)**

目标：快速、准确地识别出具备“暴力美学”的初始运动。一个候选区间必须**同时满足**以下所有动态条件：

| 指标                                      | 计算                                                      | 动态阈值                 | 目的                                 |
| :---------------------------------------- | :-------------------------------------------------------- | :----------------------- | :----------------------------------- |
| **1. 动态斜率分 (Dynamic SlopeScore)**    | `((收盘价 - 开盘价) / K线数) / ATR14`                     | `≥ P90(历史SlopeScore)`  | 确保是市场中前10%的强劲启动          |
| **2. 动态量能爆发 (Dynamic VolumeBurst)** | `区间均量 / VOL20`                                        | `≥ P85(历史VolumeBurst)` | 确保成交量显著放大，得到市场广泛认同 |
| **3. 高动量K线占比 (ImpulseBars%)**       | `长实体K线数 / 总K线数` (*长实体: `|收-开| ≥ 0.8*ATR14`*) | `≥ 70%` (此项可固定)     | 保证趋势的内在质量与力量             |
| **4. 低内部回撤 (RetraceRatio)**          | `区间内最大回撤 / 总涨跌幅`                               | `≤ 0.20` (此项可固定)    | 保证趋势的单边主导性                 |

**K线数量与缺口处理：**

*   **K线数量 (BarsCount)**：不再使用固定的 `Strict/Loose` 模式，而是根据周期动态调整。例如：`Min=2`, `Max = f(Timeframe, Volatility)`。高波动或短周期时，`Max` 自动缩紧（如5-8根）；低波动或长周期时，`Max` 自动放宽（如8-15根）。
*   **缺口处理 (Gap Handling)**：若旗杆由单根K线的巨大跳空缺口形成，`SlopeScore` 会被特殊计算（例如，视为一个极高但有上限的值），并要求**缺口后的1-2根K线必须延续该方向**，以确认为有效突破，而非衰竭缺口。

当一个旗杆被识别，系统会立即记录其核心输出：`Pole_End_Time`, `Pole_Amplitude`, `Pole_Avg_Volume`, `Pole_Avg_ATR`，并触发下一阶段。

---

### **阶段 2：智能旗面验证 (The Filter)**

目标：在前一阶段触发后，对后续的盘整进行最严格的质量检验。

**2.1 旗面形成超时规则 (Timeout Rule)**
*   旗面的寻找和验证必须在旗杆结束后 `Pole_BarsCount * 5` 根K线内完成。若超时仍未形成有效旗面，则此前的旗杆信号作废。

**2.2 盘整本质过滤 (Essence Filter)**
对于旗杆后的候选盘整区间，必须**同时满足**：

| 指标            | 计算方法                           | 动态阈值                     |
| :-------------- | :--------------------------------- | :--------------------------- |
| **1. 回撤深度** | `(区间最高-最低) / Pole_Amplitude` | `≤ P75(历史回撤深度)`        |
| **2. 量能收缩** | `区间均量 / Pole_Avg_Volume`       | `≤ P60(历史量能收缩比)`      |
| **3. 波动下降** | `区间均ATR / Pole_Avg_ATR`         | `≤ P75(历史波动下降比)`      |
| **4. 量能趋势** | 对区间成交量做线性回归的斜率       | `≤ 0` (成交量必须下降或持平) |

**2.3 几何形态与质量终检 (Geometric & Quality Validation)**
通过本质过滤的区间，将进入最终“终检”：

1.  **构建分位通道**：构建上沿 `U_t` (95%分位) 和下沿 `L_t` (5%分位)。
2.  **动态宽度检查**：通道归一化宽度 `median(U_t - L_t) / Pole_Amplitude` 必须落在 `[P20, P80]` 的历史宽度分布区间内，避免过宽或过窄。
3.  **形态分类**：并行判定矩形 (`Parallelism ≤ P60`) 或三角旗形 (`Convergence ≤ P60`)。
4.  **增强质量校验 (必选项)**：
    *   **高驻留率**：`价格位于[L_t, U_t]内的K线数 / 总K线数 ≥ 80%`。
    *   **均衡触碰**：上下轨**均需至少触碰2次**，且在旗面的**后半段，上下轨必须各有至少1次**有效触碰。

---

### **阶段 3：突破确认与执行 (The Action)**

只有通过了从阶段1到阶段2所有严苛考验的形态，才会被标记为**“高置信度旗形” (High-Confidence Flag)**，并进入待执行状态。

*   **突破确认**：
    *   **价格**：收盘价有效突破旗面通道上/下轨 (例如 `Close ≥ U_t + 0.1 * ATR14`)。
    *   **量能**：突破K线的成交量需 `≥ 区间均量的 1.5 倍` **且** `≥ VOL20`。
*   **交易执行**：
    *   **入场**：满足突破确认后，在下一根K线开盘时入场。
    *   **止损**：设置在旗面低点下方（多头）或高点上方（空头），或旗杆的0.5回撤位。
    *   **盈利目标**：
        *   **目标一**：从突破点算起，一个旗杆等距的距离 (`Pole_Amplitude`)。
        *   **目标二**：关键前高/前低或斐波那契扩展位 (1.272, 1.618)。

---

### **统一系统伪代码**

```pseudo
# ================= PHASE 0: DYNAMIC BASELINE PRE-COMPUTATION =================
# 假设 dynamic_baselines 对象已通过历史数据预先计算并滚动更新
# dynamic_baselines 包含 .pole_slope_p90, .flag_retrace_p75 等所有动态阈值

# ================= MAIN LOOP =================
for i in range(len(data)):
    
    # ================= PHASE 1: DYNAMIC FLAG-POLE IDENTIFICATION =================
    # 滑动窗口寻找潜在旗杆
    for window_size in active_bar_counts: // 根据周期和波动率确定的K线数量
        window = data[i : i+window_size]
        
        # 计算旗杆指标
        pole_candidate = calculate_pole_metrics(window)
        
        # 使用动态阈值进行验证
        is_valid_pole = (pole_candidate.slope_score >= dynamic_baselines.pole_slope_p90) and \
                        (pole_candidate.volume_burst >= dynamic_baselines.pole_volume_p85) and \
                        (pole_candidate.impulse_bars >= 0.70) and \
                        (pole_candidate.retrace_ratio <= 0.20)

        if is_valid_pole:
            # 旗杆确认！触发旗面寻找
            
            # ================= PHASE 2: INTELLIGENT FLAG-FACE VALIDATION =================
            flag_search_window = data[i+window_size : i+window_size + window_size*5] // 超时窗口
            
            # 在超时窗口内寻找高质量旗面
            potential_flag = find_high_quality_flag(
                search_window = flag_search_window,
                pole_metrics = pole_candidate,
                dynamic_baselines = dynamic_baselines
            ) # find_high_quality_flag 内部包含了本质过滤、几何分类和增强质量校验的所有逻辑
            
            if potential_flag.is_valid:
                # 最终确认！一个高置信度形态诞生
                record_high_confidence_pattern(pole_candidate, potential_flag)
                
                # ================= PHASE 3: BREAKOUT MONITORING =================
                monitor_for_breakout(
                    pattern_end_index = potential_flag.end_index,
                    upper_bound = potential_flag.upper_channel,
                    lower_bound = potential_flag.lower_channel,
                    flag_avg_volume = potential_flag.avg_volume
                )
                
                # 跳过后续检查，避免重叠
                i = potential_flag.end_index 
                break // 结束内层循环

```

**总结**

这个统一化的方案，通过动态基线解决了市场适应性问题，通过阶段式验证确保了逻辑的严谨性，并将两个原始方案的精华无缝融合。它代表了一套兼具稳健性、适应性和高标准的专业级量化交易策略。
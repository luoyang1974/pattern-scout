## 一套既“短暂而暴力”又能跨周期复用的旗杆（flag-pole）识别体系

> **核心思想**
>
> 1. **用“速度＋动量”作硬门槛**——直接衡量“短暂而暴力”。
> 2. **把 K 线数量当软门槛**——随周期与回测结果微调。
> 3. **先归一化，再计算**——用 ATR、均量等相对指标，自动适应不同波动品种。

------

### 1 ⃣ 预处理：把价格与量能“同量纲”

| 变量               | 计算            | 目的           |
| ------------------ | --------------- | -------------- |
| **ATR14** (该周期) | `ATR(14)`       | 统一“幅度”刻度 |
| **VOL20**          | 20 根成交量均值 | 统一“量能”刻度 |
| **ΔPrice/ΔTime**   | 端点价差 ÷ 根数 | 测坡度（速度） |



------

### 2 ⃣ 旗杆硬条件（所有周期都要满足）

| 指标             | 公式                     | 建议阈值 |
| ---------------- | ------------------------ | -------- |
| **SlopeScore**   | `(ΔPrice/ΔTime) / ATR14` | ≥ 6      |
| **ImpulseBars%** | `长实体 K 数 ÷ 总 K 数`  | ≥ 70 %   |
| **VolumeBurst**  | `区间均量 / VOL20`       | ≥ 1.5    |
| **RetraceRatio** | `最大回撤 / 总涨幅`      | ≤ 0.20   |



> *长实体 K*：实体长度 ≥ **0.8 ×** 该周期 ATR14。

------

### 3 ⃣ K 线数量：软约束 + 两档模式

| 周期        | **Strict** 上限 | **Loose** 上限 | 何时用                   |
| ----------- | --------------- | -------------- | ------------------------ |
| 1 – 5 min   | 5               | 8              | 高频/情绪盘 vs. 普通日内 |
| 15 – 30 min | 8               | 12             | 日内趋势 vs. 隔夜延续    |
| 1 h – 日    | 12              | 15             | 波段首动 vs. 日内多波    |
| 周          | 6               | 8              | 中期爆发 vs. 趋势腿      |
| 月          | 3               | 3              | 罕见高-紧-旗             |



- **Strict**：避免假旗杆；适合手动短线或高波动市场。
- **Loose**：提升检出率；适合量化批量扫描、较低波动品种。

------

### 4 ⃣ 实操流程（算法思路）

```
pseudo复制编辑for each instrument, timeframe:
    ATR14  = atr(14)
    VOL20  = sma(volume, 20)

    # ① 滑窗枚举候选区间
    for window in sliding_windows(data, min=2, max=LooseBarMax):
        dP_dt   = (close[-1] - open[0]) / len(window)
        slope   = dP_dt / ATR14
        retrace = (max_high - min_low) / (close[-1] - open[0])
        impulse = count(|body| ≥ 0.8*ATR14) / len(window)
        volBst  = avg(volume[window]) / VOL20

        # ② 硬条件
        if slope ≥ 6 and impulse ≥ 0.7 and volBst ≥ 1.5 and retrace ≤ 0.2:
            
            # ③ 根数软条件
            if len(window) ≤ StrictBarMax:
                tag = "flagpole_strict"
            elif len(window) ≤ LooseBarMax:
                tag = "flagpole_loose"
            else:
                continue   # 抛弃，视作趋势腿

            record_candidate(window, tag)
```

------

### 5 ⃣ 旗杆 + 旗面 + 突破：三段式交易逻辑

1. **发现旗杆**：满足上表条件。
2. **验证旗面**：
   - 2–20 根斜行 / 横盘整理；
   - 成交量缩减至旗杆期 **30–60 %**；
   - 波动率（ATR）回落。
3. **突破建仓**：价格放量突破旗面高点；
   - **止损**：旗面低点或旗杆 0.382 回撤；
   - **第一目标**：旗杆“等幅测量”；
   - **第二目标**：Fibonacci 1.272–1.618 延伸或前高压力。

------

### 6 ⃣ 回测与动态优化

| 步骤         | 要点                                                         |
| ------------ | ------------------------------------------------------------ |
| **A/B 回测** | 同一数据集分别跑 Strict 与 Loose，比较命中率、胜率、Sharpe。 |
| **波动调整** | 当 20 日 HV 突破长均值 2 × 时，上调 `SlopeScore` 与 `BarsMax` 阈值，避免噪声。 |
| **分桶回测** | 按品种流动性/行业/市值分组，寻找最优 `BarsMax`。             |



------

## 结论与建议

- **硬性速度-动量指标** 决定“暴力”——保证形态纯度。
- **K 线数量** 决定“短暂”——可根据周期与回测灵活调节。
- 在 **超短高波动** 市场，坚持 “≤5 根” 极简规则更安全；
- 在 **日线/周线** 波段或低波动品种，用 “≤8-15 根” 的 **Loose 模式** 能显著提高信号覆盖率而不明显降低质量。


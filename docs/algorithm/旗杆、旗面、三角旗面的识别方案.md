## 旗杆（flag-pole）识别

> **核心思想**
>
> 1. **用“速度＋动量”作硬门槛**——直接衡量“短暂而暴力”。
> 2. **把 K 线数量当软门槛**——随周期与回测结果微调。
> 3. **先归一化，再计算**——用 ATR、均量等相对指标，自动适应不同波动品种。

------

### 1 ⃣ 预处理：把价格与量能“同量纲”

| 变量               | 计算            | 目的           |
| ------------------ | --------------- | -------------- |
| **ATR14** (该周期) | `ATR(14)`       | 统一“幅度”刻度 |
| **VOL20**          | 20 根成交量均值 | 统一“量能”刻度 |
| **ΔPrice/ΔTime**   | 端点价差 ÷ 根数 | 测坡度（速度） |



------

### 2 ⃣ 旗杆硬条件（所有周期都要满足）

| 指标             | 公式                     | 建议阈值 |
| ---------------- | ------------------------ | -------- |
| **SlopeScore**   | `(ΔPrice/ΔTime) / ATR14` | ≥ 6      |
| **ImpulseBars%** | `长实体 K 数 ÷ 总 K 数`  | ≥ 70 %   |
| **VolumeBurst**  | `区间均量 / VOL20`       | ≥ 1.5    |
| **RetraceRatio** | `最大回撤 / 总涨幅`      | ≤ 0.20   |



> *长实体 K*：实体长度 ≥ **0.8 ×** 该周期 ATR14。

------

### 3 ⃣ K 线数量：软约束 + 两档模式

| 周期        | **Strict** 上限 | **Loose** 上限 | 何时用                   |
| ----------- | --------------- | -------------- | ------------------------ |
| 1 – 5 min   | 5               | 8              | 高频/情绪盘 vs. 普通日内 |
| 15 – 30 min | 8               | 12             | 日内趋势 vs. 隔夜延续    |
| 1 h – 日    | 12              | 15             | 波段首动 vs. 日内多波    |
| 周          | 6               | 8              | 中期爆发 vs. 趋势腿      |
| 月          | 3               | 3              | 罕见高-紧-旗             |



- **Strict**：避免假旗杆；适合手动短线或高波动市场。
- **Loose**：提升检出率；适合量化批量扫描、较低波动品种。

------

### 4 ⃣ 实操流程（算法思路）

```
pseudo复制编辑for each instrument, timeframe:
    ATR14  = atr(14)
    VOL20  = sma(volume, 20)

    # ① 滑窗枚举候选区间
    for window in sliding_windows(data, min=2, max=LooseBarMax):
        dP_dt   = (close[-1] - open[0]) / len(window)
        slope   = dP_dt / ATR14
        retrace = (max_high - min_low) / (close[-1] - open[0])
        impulse = count(|body| ≥ 0.8*ATR14) / len(window)
        volBst  = avg(volume[window]) / VOL20

        # ② 硬条件
        if slope ≥ 6 and impulse ≥ 0.7 and volBst ≥ 1.5 and retrace ≤ 0.2:
            
            # ③ 根数软条件
            if len(window) ≤ StrictBarMax:
                tag = "flagpole_strict"
            elif len(window) ≤ LooseBarMax:
                tag = "flagpole_loose"
            else:
                continue   # 抛弃，视作趋势腿

            record_candidate(window, tag)
```

------

### 5 ⃣ 旗杆 + 旗面 + 突破：三段式交易逻辑

1. **发现旗杆**：满足上表条件。
2. **验证旗面**：
   - 2–20 根斜行 / 横盘整理；
   - 成交量缩减至旗杆期 **30–60 %**；
   - 波动率（ATR）回落。
3. **突破建仓**：价格放量突破旗面高点；
   - **止损**：旗面低点或旗杆 0.382 回撤；
   - **第一目标**：旗杆“等幅测量”；
   - **第二目标**：Fibonacci 1.272–1.618 延伸或前高压力。

------

### 6 ⃣ 回测与动态优化

| 步骤         | 要点                                                         |
| ------------ | ------------------------------------------------------------ |
| **A/B 回测** | 同一数据集分别跑 Strict 与 Loose，比较命中率、胜率、Sharpe。 |
| **波动调整** | 当 20 日 HV 突破长均值 2 × 时，上调 `SlopeScore` 与 `BarsMax` 阈值，避免噪声。 |
| **分桶回测** | 按品种流动性/行业/市值分组，寻找最优 `BarsMax`。             |



------

### 结论与建议

- **硬性速度-动量指标** 决定“暴力”——保证形态纯度。
- **K 线数量** 决定“短暂”——可根据周期与回测灵活调节。
- 在 **超短高波动** 市场，坚持 “≤5 根” 极简规则更安全；
- 在 **日线/周线** 波段或低波动品种，用 “≤8-15 根” 的 **Loose 模式** 能显著提高信号覆盖率而不明显降低质量。



## 旗面识别

> **核心思想**
>
> 1.  **相对收缩原则**：旗面的所有特征（成交量、波动性）都是相对于其前序旗杆而言的。它是一个“相对”概念。
> 2.  **形态约束原则**：旗面应呈现出清晰的通道或楔形整理形态，价格在有限的范围内波动，而不是无序发散。
> 3.  **浅度回撤原则**：旗面对旗杆的修正幅度必须是有限的，深V型反转不是旗面。

------

### 1⃣ 旗面识别的前提

**必须首先成功识别出一个“旗杆”**。旗面的识别是旗杆识别的下游步骤，它验证的是旗杆之后的那段整理期。

### 2⃣ 旗面识别的四大核心量化指标

我们从**时长、回撤、量能、波动**四个维度来定义旗面。

| 指标 (Metric)                       | 计算公式 / 定义                     | 建议阈值                  | 目的                                                   |
| :---------------------------------- | :---------------------------------- | :------------------------ | :----------------------------------------------------- |
| **1. DurationRatio** (时长比例)     | `旗面 K 线数 / 旗杆 K 线数`         | `1.0 ≤ x ≤ 5.0`           | 确保盘整时间合理，不过长也不过短。                     |
| **2. RetracementDepth** (回撤深度)  | `旗面对旗杆的回撤幅度 / 旗杆总幅度` | `≤ 0.50` (理想 `≤ 0.382`) | **关键指标**：过滤掉过深的调整，防止识别出潜在的反转。 |
| **3. VolumeContraction** (量能收缩) | `旗面区间均量 / 旗杆区间均量`       | `≤ 0.6`                   | 验证市场在整理期间交投清淡，是为下一波行情蓄力的信号。 |
| **4. VolatilityDrop** (波动下降)    | `旗面区间均 ATR / 旗杆区间均 ATR`   | `≤ 0.7`                   | 确认市场从旗杆的“暴力”模式切换到“平静”的整理模式。     |

**计算细则：**

*   **回撤深度**：对于上涨旗杆，计算 `(旗杆最高点 - 旗面最低点) / (旗杆最高点 - 旗杆最低点)`。对于下跌旗杆则相反。
*   **区间均ATR**：分别计算在旗杆区间和旗面区间的 `ATR(14)` 的平均值。

------

### 3⃣ 旗面形态的几何约束 (高级选项)

为了进一步提高识别的准确率，我们可以引入对旗面“形状”的量化约束。最常见的方法是**线性回归通道**。

| 指标 (Metric)               | 方法                                                         | 建议阈值                                             | 目的                                                       |
| :-------------------------- | :----------------------------------------------------------- | :--------------------------------------------------- | :--------------------------------------------------------- |
| **ChannelFit** (通道拟合度) | 1. 对旗面区间的所有K线高点做线性回归，得到上轨。<br>2. 对所有K线低点做线性回归，得到下轨。<br>3. 计算价格点到回归线的相关系数 R² (R-squared)。 | `R² ≥ 0.7`                                           | 确保价格在一个相对规整的通道内运动，过滤掉杂乱无章的盘整。 |
| **ChannelSlope** (通道坡度) | 计算上下轨的平均斜率。                                       | 1. **牛旗**: `Slope ≤ 0`<br>2. **熊旗**: `Slope ≥ 0` | 确保旗面是水平或逆着旗杆方向轻微倾斜的，这是最经典的形态。 |

这个步骤可以筛掉那些虽然满足了前述四大指标，但形态上并不收敛（例如，扩散喇叭形）的候选对象。

------

### 4⃣ 实操流程（算法思路）

这个算法紧接着您的旗杆识别算法运行。

```
pseudo复制编辑// 假设 flagpole_list 是你用之前算法找到的所有旗杆
for each flagpole in flagpole_list:
    
    // ① 定义旗面搜索窗口
    // 从旗杆结束后第一根K线开始，向后搜索，例如最多搜索30根K线
    search_window = data.after(flagpole).limit(30) 
    
    // ② 滑动枚举潜在的旗面区间
    // 旗面至少需要3根K线才能形成形态
    for i from 3 to len(search_window):
        potential_flag = search_window[0:i]
        
        // ③ 计算四大核心指标
        duration_ratio = len(potential_flag) / len(flagpole)
        retrace_depth  = calculate_retrace(flagpole, potential_flag)
        volume_ratio   = avg(volume(potential_flag)) / avg(volume(flagpole))
        atr_ratio      = avg(atr(potential_flag)) / avg(atr(flagpole))
        
        // ④ 应用硬性阈值进行筛选
        is_duration_ok  = (duration_ratio >= 1.0 and duration_ratio <= 5.0)
        is_retrace_ok   = (retrace_depth <= 0.5)
        is_volume_ok    = (volume_ratio <= 0.6)
        is_volatility_ok= (atr_ratio <= 0.7)
        
        if is_duration_ok and is_retrace_ok and is_volume_ok and is_volatility_ok:
            
            // (可选) ⑤ 应用几何约束
            channel_r_squared = calculate_channel_fit(potential_flag)
            if channel_r_squared >= 0.7:
                
                // 这是一个高质量的旗面候选
                record_flag_pattern(flagpole, potential_flag)
                
                // 找到一个后可以继续搜索更长的旗面，或直接跳出，取决于策略
                // continue or break
```

------

### 结论与建议

1.  **先严后宽**：在初步设计和回测时，建议使用最严格的参数（如回撤`≤ 0.382`，量能`≤ 0.5`），以确保找到最经典的旗形形态。这能帮你建立一个高质量的基准。
2.  **动态时长**：`DurationRatio` 是一个非常强大的工具。它可以让旗面识别自动适应不同周期的旗杆。一个5根K线的分钟线旗杆，其旗面可能在5-25根K线内；而一个12根K线的日线旗杆，其旗面可能会持续数周。
3.  **核心是回撤与量能**：在所有指标中，`RetracementDepth` 和 `VolumeContraction` 是最重要的。它们直接反映了市场情绪：多头（或空头）是否在休息，而不是在逃跑。
4.  **整合交易逻辑**：一旦旗面被确认，您的交易逻辑的第三步“**突破建仓**”就可以无缝衔接了。突破信号就是价格有效（最好放量）突破我们用几何方法计算出的旗面上轨（或下轨）。

## 三角旗面识别


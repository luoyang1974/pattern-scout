#   旗杆检测算法详细流程

##   一、算法架构总览

  PatternScout的旗杆检测器是六阶段识别系统的第一阶段，实现"短暂而暴力"的旗杆识别理念：

  阶段0: 基线系统 → 阶段1: 旗杆检测 → 阶段2: 旗面检测

##   二、核心检测流程

  1. 初始化和数据准备

**入口：**FlagpoleDetector.detect_flagpoles()

  def detect_flagpoles(df, current_regime, timeframe="15m") -> List[Flagpole]

  数据验证:
  - 最小数据要求：100条K线（确保有足够的历史统计数据）
  - 计算基础技术指标：ATR14、成交量MA20、价格变化百分比

  2. 动态阈值获取 src/patterns/detectors/flagpole_detector.py:103

  基于当前市场状态（高/低波动）获取动态阈值：

**主要阈值指标**

  thresholds = {
      'slope_score_p90': 基线管理器获取的P90斜率分阈值,    # 默认0.5（已调优）
      'volume_burst_p85': 基线管理器获取的P85量能爆发阈值,  # 默认1.5（已调优）
      'retrace_depth_p75': 基线管理器获取的P75回撤深度阈值  # 默认0.3
  }

  3. 动态K线数量范围计算 src/patterns/detectors/flagpole_detector.py:131

  根据时间周期和市场状态确定旗杆长度范围：

| 时间周期 | 基础范围 | 高波动调整 | 低波动调整 |
| -------- | -------- | ---------- | ---------- |
| 15m      | 4-15根   | 3-12根     | 4-18根     |
| 1h       | 3-12根   | 2-9根      | 3-14根     |
| 1d       | 2-6根    | 2-4根      | 2-7根      |

  4. 滑动窗口候选区间扫描 src/patterns/detectors/flagpole_detector.py:76

  双重循环扫描：
  - 外层：遍历不同的K线数量（min_bars到max_bars）
  - 内层：滑动窗口遍历整个数据序列
  - 每个候选区间调用_analyze_flagpole_candidate()进行详细分析

##   三、六重验证机制

  每个候选旗杆必须通过六重验证才能被识别：

  验证1: 动态斜率分验证 src/patterns/detectors/flagpole_detector.py:280

  斜率分 = |收盘价 - 开盘价| / K线数 / ATR14
  - 物理意义：相对于市场波动率的价格变化强度
  - 阈值：P90百分位数（基线系统自适应，默认0.5）
  - 目的：确保价格变动足够"暴力"

  验证2: 动态量能爆发验证 src/patterns/detectors/flagpole_detector.py:299

  量能爆发比 = 区间均量 / VOL20
  - 物理意义：相对于历史平均的成交量放大倍数
  - 阈值：P85百分位数（基线系统自适应，默认1.5倍）
  - 目的：确认有资金推动的真实突破

  验证3: 高动量K线占比验证 src/patterns/detectors/flagpole_detector.py:315

  if |收-开| ≥ 0.8 * ATR14:
      该K线为高动量K线
  高动量K线占比 = 高动量K线数 / 总K线数
  - 阈值：30%（经过优化调整）
  - 目的：确保大部分K线都体现强势特征

  验证4: 低内部回撤验证 src/patterns/detectors/flagpole_detector.py:334

**上涨旗杆**

  运行最高点序列 = 累积收益序列的rolling max
  回撤序列 = 运行最高点 - 当前累积收益
  最大回撤比例 = max(回撤序列) / 总涨幅

**下跌旗杆类似逻辑**

  - 阈值：30%（放宽至实用水平）
  - 目的：确保旗杆具有方向性一致性，避免震荡性价格

  验证5: 缺口处理验证 src/patterns/detectors/flagpole_detector.py:370

  缺口百分比 = |当前开盘价 - 前一收盘价| / 前一收盘价
  有效缺口范围 = 2% - 10%
  - 检测逻辑：识别跳空缺口
  - 验证要求：缺口后需要延续性确认
  - 目的：处理跳空高开/低开情况

  验证6: 趋势强度验证（R²）src/patterns/detectors/flagpole_detector.py:413

**使用线性回归计算价格趋势的拟合度**

  from scipy.stats import linregress
  slope, intercept, r_value, p_value, std_err = linregress(x, y)
  趋势强度 = r_value²
  - 目的：评估价格走势的线性趋势特征

##   四、重叠检测和去重机制

  时间重叠检查 src/patterns/detectors/flagpole_detector.py:450

  def _overlaps_with_existing(candidate, existing) -> bool:
      # 检查时间区间是否重叠
      if not (candidate.end_time < existing.start_time or
             candidate.start_time > existing.end_time):
          return True

  质量优化选择 src/patterns/detectors/flagpole_detector.py:470

**按斜率分排序，保留质量最高的旗杆**

  sorted_poles = sorted(flagpoles, key=lambda x: x.slope_score, reverse=True)

##   五、基线系统集成

  动态阈值更新 src/patterns/detectors/flagpole_detector.py:432

  每检测到一个有效旗杆，就更新基线系统：

  self.baseline_manager.update_baseline(regime, SLOPE_SCORE, slope_score, timestamp)
  self.baseline_manager.update_baseline(regime, VOLUME_BURST, volume_burst, timestamp)
  self.baseline_manager.update_baseline(regime, RETRACE_DEPTH, retracement_ratio, timestamp)

  三层鲁棒统计保护

  - MAD过滤：去除明显异常值
  - Winsorize化：压缩极端值
  - 阈值调整：自适应调整检测参数

##   六、性能特征

  - 处理速度：250记录/秒，4ms/记录
  - 扩展因子：1.04（接近理想的线性扩展）
  - 适应性：支持分钟线到月线的全时间周期检测
  - 鲁棒性：三层统计保护，防止异常数据污染

##   七、输出数据结构

  检测到的旗杆包含完整的特征数据：

  @dataclass
  class Flagpole:
      # 基础信息
      start_time, end_time, start_price, end_price
      height, height_percent, direction, bars_count

      # 动态检测指标
      slope_score: float      # 动态斜率分（核心质量指标）
      volume_burst: float     # 量能爆发比
      impulse_bar_ratio: float # 高动量K线占比
      retracement_ratio: float # 内部回撤比例
      trend_strength: float   # 趋势强度（R²）

  这个算法的核心优势是自适应性和鲁棒性，能够根据不同市场环境和时间周期自动调整识别参数，同时通过多维度验证确保识别的旗杆具有真实的技术分析意义。

# 旗杆检测算法简要说明

##   核心理念

  识别"短暂而暴力"的价格突破阶段，作为旗形形态的第一组成部分。

##   主要流程

  1. ### 数据准备

  - 验证最少100条K线数据
  - 计算ATR14、成交量MA20等基础指标
  - 获取当前市场状态（高/低波动）

  2. ### 动态参数设置

  - 根据时间周期确定K线数量范围（如15分钟：4-15根）
  - 从基线系统获取动态阈值（斜率分P90、量能爆发P85等）
  - 市场状态调整：高波动缩短旗杆，低波动延长旗杆

  3. ### 滑动窗口扫描

  双重循环遍历所有候选区间，对每个区间进行六重验证：

  验证1 - 动态斜率分：|收盘-开盘|/K线数/ATR14 ≥ 阈值
  验证2 - 量能爆发：区间均量/VOL20 ≥ 1.5倍验证3 - 高动量K线占比：长实体K线占比 ≥ 30%
  验证4 - 低内部回撤：最大回撤/总涨跌幅 ≤ 30%
  验证5 - 缺口处理：检测2%-10%跳空缺口并验证延续性
  验证6 - 趋势强度：线性回归R²评估方向一致性

  4. ### 去重优化

  - 检测时间重叠的旗杆
  - 按斜率分排序，保留质量最高的候选

  5. ### 基线更新

  每识别一个有效旗杆，更新对应市场状态的基线数据，实现自适应学习。

##   关键特点

  - 自适应阈值：基于500K线滚动统计的动态调整
  - 多维验证：确保旗杆同时满足价格、成交量、动量特征
  - 鲁棒性：三层统计保护防止异常值干扰
  - 全周期支持：1分钟到月线的参数自动适配
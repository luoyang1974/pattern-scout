# 模式识别算法改进设计方案

本文档旨在详细阐述旗形（Flag）和三角旗形（Pennant）两种技术形态的算法改进方案。本次重新设计的核心目标是提升算法在真实市场环境中的**稳健性**、对不同市场波动状态的**自适应性**以及形态识别的**准确性**。

---

### **1. 核心组件增强**

在阐述具体的检测算法前，首先定义若干增强的、可被两种检测器共用的核心组件。

#### **1.1. 摆动点检测 (替代 `find_key_points`)**

-   **目标**: 可靠地识别出市场的重要转折点（即摆动高点和摆动低点），并过滤掉无意义的次级波动。
-   **算法**:
    1.  定义一个 `find_swing_points` (寻找摆动点) 函数。
    2.  **摆动高点 (Swing High)**: 一个价格高点，其价格高于其前 `N` 个和后 `N` 个周期内的所有最高价。
    3.  **摆动低点 (Swing Low)**: 一个价格低点，其价格低于其前 `N` 个和后 `N` 个周期内的所有最低价。
    4.  参数 `N` (例如 `N=5`) 将根据不同的时间周期类别进行配置，以调整其敏感度。这种方法相比简单地选取局部极值点，能更稳健地找到趋势线的锚点。

#### **1.2. 稳健的趋势线拟合**

-   **目标**: 拟合出不受价格尖峰或长影线等异常值过度影响的趋势线。
-   **主算法: RANSAC (随机样本一致性)**
    1.  从识别出的摆动点集合中，RANSAC 算法将迭代式地随机选取一个点的子集来拟合一条初始线。
    2.  然后，算法会计算完整点集中有多少点与这条线足够接近（在某个容差范围内），这些点被称为“内点”(inliers)。
    3.  重复此过程，最终选择拥有最多“内点”的那条线作为最佳拟合结果。
    4.  容差范围将基于当前市场波动率（如 ATR 的一部分）进行动态设置，而非固定值。
-   **备用算法: OLS (普通最小二乘法)**
    1.  如果 RANSAC 算法因任何原因（如依赖库问题）执行失败，系统将自动回退到标准的线性回归方法。这确保了系统的稳定运行。

#### **1.3. 波动率自适应参数**

-   **目标**: 使检测逻辑能够根据当前市场的波动状态进行自我调整。
-   **算法**:
    1.  对于任何给定的数据集，首先计算其 **ATR (平均真实波幅)** 指标（例如，周期为14）。
    2.  将核心的检测参数用 ATR 的倍数来定义，而不是固定的百分比或价格点数。
    3.  **受影响的关键参数**:
        -   **旗杆高度**: 最小高度要求将是 `X * ATR` (例如 `5 * ATR`)。
        -   **形态回撤**: 形态内部允许的最大价格回撤幅度将与 ATR 相关。
        -   **RANSAC 容差**: 判断一个点是否为“内点”的距离阈值将是 ATR 的一小部分。

#### **1.4. 增强的成交量分析**

-   **目标**: 超越简单的平均值比较，转而分析形态内部成交量的演变趋势。
-   **算法**:
    1.  在潜在的形态区域（旗形或三角旗形）内，提取成交量序列。
    2.  对成交量序列和时间进行线性回归。
    3.  **主要条件**: 一个健康的整理形态应表现出成交量趋势的**负斜率**，即成交量随着形态的形成而逐渐萎缩。
    4.  **次要条件**: 增加一个对极端低成交量的检查。如果形态内的平均成交量低于某个阈值（例如，低于长期成交量均线的50%），则该形态可能因流动性不足而被标记为低质量。

---

### **2. 旗形检测算法 (修订版)**

**第一步: 识别旗杆**
-   基本识别逻辑不变，但 `min_height` (最小高度) 参数将采用波动率自适应的机制（基于ATR）。

**第二步: 隔离潜在的旗面区域**
-   在旗杆结束后，迭代不同的旗面持续时间（`min_bars` 到 `max_bars`）。

**第三步: 分析旗面形态 (修订版 `_analyze_flag_pattern`)**
1.  **寻找摆动点**: 在潜在的旗面区域内，使用 `find_swing_points` 函数识别出所有的摆动高点和摆动低点。
2.  **使用 RANSAC 拟合边界**:
    -   使用 RANSAC 算法将识别出的摆动高点拟合成一条上轨趋势线。
    -   使用 RANSAC 算法将识别出的摆动低点拟合成一条下轨趋势线。
    -   如果任何一侧的摆动点数量少于2个，则该形态在此持续时间下无效。
3.  **验证通道属性**:
    -   **反向倾斜**: 验证通道的平均斜率与旗杆方向相反。
    -   **发散检查 (新增)**: 检查两条边界线是否正在发散。通道在结束时的宽度不应显著大于开始时的宽度。
    -   **平行质量**: 保留现有的平行质量评分，作为衡量形态优劣的指标之一。
4.  **验证成交量**:
    -   应用**增强的成交量分析**：检查旗面区域内的成交量是否存在下降趋势。
    -   确保平均成交量相比旗杆有所下降。
5.  **评分与选择**:
    -   基于 RANSAC 的拟合质量（内点数量）、平行质量、成交量下降趋势的强度以及形态的几何完美度，计算一个综合置信度分数。
    -   选择得分最高且超过最低置信度阈值的旗面窗口作为最终结果。

---

### **3. 三角旗形检测算法 (修订版)**

**第一步: 识别旗杆**
-   与旗形检测的修订版相同。

**第二步: 隔离潜在的三角旗形区域**
-   迭代不同的三角旗形持续时间。

**第三步: 分析三角旗形形态 (修订版 `_analyze_pennant_pattern`)**
1.  **寻找摆动点**: 在潜在的形态区域内，识别出所有的摆动高点和摆动低点。
2.  **使用 RANSAC 拟合边界**:
    -   对摆动高点拟合上轨趋势线。
    -   对摆动低点拟合下轨趋势线。
3.  **分类并验证三角形态 (核心改进)**:
    -   **收敛检查**: 验证两条趋势线的斜率是否表明它们正在收敛（即将在未来的某个点相交）。如果平行或发散，则判定为无效形态。
    -   **水平检查**: 检查是否有其中一条线的斜率接近于零。
    -   **形态分类**:
        -   如果 `上轨斜率 < 0` 且 `下轨斜率 > 0`: **对称三角形 (Symmetric Triangle)**。
        -   如果 `上轨斜率` 接近水平 且 `下轨斜率 > 0`: **上升三角形 (Ascending Triangle)**。
        -   如果 `下轨斜率` 接近水平 且 `上轨斜率 < 0`: **下降三角形 (Descending Triangle)**。
        -   其他组合被视为无效的三角旗形。
4.  **验证 Apex (交点)**:
    -   计算两条线的理论交点。
    -   验证 Apex 在时间轴上的位置是否在合理范围内（不太近也不太远），与原算法类似。
5.  **验证成交量**:
    -   应用**增强的成交量分析**，确保成交量呈下降趋势。
6.  **评分与选择**:
    -   基于 RANSAC 的拟合质量、收敛强度、三角形态的清晰度（例如，在上升/下降三角形中，水平边的平坦程度）以及成交量趋势，计算综合置信度分数。
    -   选择得分最高的三角旗形窗口。